name: ğŸ“ ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ãƒ–ãƒ­ã‚°æŠ•ç¨¿

on:
  workflow_dispatch:
    inputs:
      keyword:
        description: 'ãƒ–ãƒ­ã‚°ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼šAIãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚° æœ€æ–°ãƒˆãƒ¬ãƒ³ãƒ‰ï¼‰'
        required: true
        type: string
      title:
        description: 'ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ - ç©ºæ¬„ã®å ´åˆã¯è‡ªå‹•ç”Ÿæˆï¼‰'
        required: false
        type: string
      category:
        description: 'ã‚«ãƒ†ã‚´ãƒªãƒ¼'
        required: true
        type: choice
        options:
          - AIãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°
          - æ¶ˆè²»è€…å¿ƒç†
          - æˆåŠŸäº‹ä¾‹
          - å®Ÿè·µãƒ†ã‚¯ãƒ‹ãƒƒã‚¯
          - ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
          - æ¥­ç•Œåˆ¥ã‚¬ã‚¤ãƒ‰
        default: AIãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°
      instinct:
        description: 'è¨´æ±‚ã™ã‚‹æœ¬èƒ½'
        required: true
        type: choice
        options:
          - learningï¼ˆå­¦ç¿’æ¬²ï¼‰
          - hierarchyï¼ˆåœ°ä½å‘ä¸Šï¼‰
          - survivalï¼ˆãƒªã‚¹ã‚¯å›é¿ï¼‰
          - territorialï¼ˆç«¶äº‰å„ªä½ï¼‰
          - nurturingï¼ˆé¡§å®¢ã‚±ã‚¢ï¼‰
          - reproductionï¼ˆæˆé•·æ‹¡å¤§ï¼‰
        default: learning
      publish_immediately:
        description: 'ã™ãã«å…¬é–‹ã™ã‚‹'
        required: true
        type: boolean
        default: true

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  UNSPLASH_API_KEY: ${{ secrets.UNSPLASH_API_KEY }}

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        token: ${{ github.token }}
        persist-credentials: true
    
    - name: ğŸ“‹ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: ğŸ”§ Ruby ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2.0'
    
    - name: ğŸ“¦ Ruby ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        gem update --system
        gem install bundler -v 2.4.0
        bundle config set --local path 'vendor/bundle'
        bundle install || echo "Bundle install failed, continuing..."
    
    - name: ğŸ“¦ Node.js ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        cd scripts/blog-automation
        npm install
    
    - name: ğŸ¯ ãƒ–ãƒ­ã‚°ç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š
      id: blog-params
      run: |
        echo "keyword=${{ inputs.keyword }}" >> $GITHUB_OUTPUT
        echo "category=${{ inputs.category }}" >> $GITHUB_OUTPUT
        echo "instinct=${{ inputs.instinct }}" >> $GITHUB_OUTPUT
        
        # ã‚¿ã‚¤ãƒˆãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ç©ºæ–‡å­—
        if [ -n "${{ inputs.title }}" ]; then
          echo "title=${{ inputs.title }}" >> $GITHUB_OUTPUT
        else
          echo "title=" >> $GITHUB_OUTPUT
        fi
        
        # æ—¥æœ¬æ™‚é–“ã§ã®æ—¥ä»˜
        TZ='Asia/Tokyo' date '+%Y-%m-%d %H:%M' > generation_time.txt
        echo "generated_at=$(cat generation_time.txt)" >> $GITHUB_OUTPUT
    
    - name: ğŸ¤– ãƒ–ãƒ­ã‚°è¨˜äº‹ç”Ÿæˆ
      id: generate
      run: |
        cd scripts/blog-automation
        
        # ç’°å¢ƒå¤‰æ•°è¨­å®š
        export BLOG_KEYWORD="${{ steps.blog-params.outputs.keyword }}"
        export BLOG_CATEGORY="${{ steps.blog-params.outputs.category }}"
        export BLOG_INSTINCT="${{ steps.blog-params.outputs.instinct }}"
        export BLOG_TITLE="${{ steps.blog-params.outputs.title }}"
        
        # APIã‚­ãƒ¼ã®ç¢ºèªã¨ç”Ÿæˆ
        if [ -z "${{ env.ANTHROPIC_API_KEY }}" ]; then
          echo "âš ï¸ APIã‚­ãƒ¼ãªã— - ãƒ¢ãƒƒã‚¯ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ç”¨"
          node mock-blog-generator.js "$BLOG_KEYWORD"
        else
          echo "âœ… Claude APIã‚’ä½¿ç”¨ã—ã¦ç”Ÿæˆ"
          
          # ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å«ã‚€ç”Ÿæˆï¼ˆSEOæœ€é©åŒ–ï¼‹çµè«–ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆï¼‰
          node claude-blog-generator.js "$BLOG_KEYWORD"
        fi
        
        # ç”Ÿæˆçµæœã®ç¢ºèª
        TODAY=$(date '+%Y-%m-%d')
        NEW_POST=$(find ../../_posts -name "${TODAY}-*.md" -type f | head -1)
        
        if [ -n "$NEW_POST" ]; then
          echo "success=true" >> $GITHUB_OUTPUT
          echo "filename=$(basename $NEW_POST)" >> $GITHUB_OUTPUT
          
          # ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡º
          TITLE=$(grep '^title:' "$NEW_POST" | sed 's/title: *"*\([^"]*\)"*/\1/')
          echo "title=$TITLE" >> $GITHUB_OUTPUT
        else
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: ğŸ”¨ Jekyll ãƒ“ãƒ«ãƒ‰ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      if: steps.generate.outputs.success == 'true'
      run: |
        echo "Jekyll ãƒ“ãƒ«ãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆGitHub Pages ãŒè‡ªå‹•çš„ã«ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ï¼‰"
        # bundle exec jekyll build || echo "Jekyll build skipped"
    
    - name: ğŸ“¤ å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
      if: steps.generate.outputs.success == 'true' && inputs.publish_immediately
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions Blog Bot"
        
        # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        mkdir -p assets/images/blog
        
        # å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
        git add _posts/ || echo "No posts to add"
        git add assets/images/blog/ 2>/dev/null || echo "No images to add"
        git add _site/ 2>/dev/null || echo "No _site to add"
        
        # ã‚³ãƒŸãƒƒãƒˆ
        COMMIT_TITLE="ğŸ“ ãƒ–ãƒ­ã‚°æŠ•ç¨¿: ${{ steps.generate.outputs.title }}"
        COMMIT_BODY="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${{ inputs.keyword }}
        ã‚«ãƒ†ã‚´ãƒªãƒ¼: ${{ inputs.category }}
        ç”Ÿæˆæ™‚åˆ»: ${{ steps.blog-params.outputs.generated_at }} JST
        å®Ÿè¡Œè€…: ${{ github.actor }}"
        
        git commit -m "$COMMIT_TITLE" -m "$COMMIT_BODY" || echo "No changes to commit"
        
        # Push with GitHub token
        git push origin HEAD:main || echo "Push failed"
    
    - name: ğŸ“Š ã‚µãƒãƒªãƒ¼ä½œæˆ
      if: always()
      run: |
        echo "## ğŸ“ ãƒ–ãƒ­ã‚°ç”Ÿæˆçµæœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.generate.outputs.success }}" == "true" ]; then
          echo "âœ… **ç”ŸæˆæˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¿ã‚¤ãƒˆãƒ«**: ${{ steps.generate.outputs.title }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ•ã‚¡ã‚¤ãƒ«**: ${{ steps.generate.outputs.filename }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰**: ${{ inputs.keyword }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚«ãƒ†ã‚´ãƒªãƒ¼**: ${{ inputs.category }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è¨´æ±‚æœ¬èƒ½**: ${{ inputs.instinct }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç”Ÿæˆæ™‚åˆ»**: ${{ steps.blog-params.outputs.generated_at }} JST" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.publish_immediately }}" == "true" ]; then
            echo "ğŸ“¢ **å…¬é–‹çŠ¶æ…‹**: å³æ™‚å…¬é–‹æ¸ˆã¿" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¨˜äº‹ã¯æ•°åˆ†å¾Œã«ã‚µã‚¤ãƒˆã«åæ˜ ã•ã‚Œã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "ğŸ“‹ **å…¬é–‹çŠ¶æ…‹**: ä¸‹æ›¸ãä¿å­˜" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âŒ **ç”Ÿæˆå¤±æ•—**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: ğŸ’¬ Slack é€šçŸ¥
      if: steps.generate.outputs.success == 'true' && env.SLACK_WEBHOOK_URL != ''
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        curl -X POST $SLACK_WEBHOOK_URL \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "ğŸ“ ãƒ–ãƒ­ã‚°è¨˜äº‹ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ğŸ“ æ–°ã—ã„ãƒ–ãƒ­ã‚°è¨˜äº‹ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ*"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*ã‚¿ã‚¤ãƒˆãƒ«*\n${{ steps.generate.outputs.title }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*å®Ÿè¡Œè€…*\n${{ github.actor }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰*\n${{ inputs.keyword }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ã‚«ãƒ†ã‚´ãƒªãƒ¼*\n${{ inputs.category }}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "ğŸ”— <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|è©³ç´°ã‚’è¦‹ã‚‹>"
                }
              }
            ]
          }'