name: ğŸ“… ãƒ–ãƒ­ã‚°æŠ•ç¨¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]
  workflow_dispatch:

jobs:
  process-blog-request:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'blog-request') || contains(github.event.issue.title, '[ãƒ–ãƒ­ã‚°]')
    
    steps:
    - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: ğŸ” ãƒªã‚¯ã‚¨ã‚¹ãƒˆè§£æ
      id: parse-request
      uses: actions/github-script@v7
      with:
        script: |
          const issue = context.payload.issue;
          const body = issue.body || '';
          
          // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŠ½å‡º
          const keywordMatch = body.match(/ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰[:ï¼š]\s*(.+)/);
          const titleMatch = body.match(/ã‚¿ã‚¤ãƒˆãƒ«[:ï¼š]\s*(.+)/);
          const categoryMatch = body.match(/ã‚«ãƒ†ã‚´ãƒªãƒ¼[:ï¼š]\s*(.+)/);
          const dateMatch = body.match(/æŠ•ç¨¿æ—¥[:ï¼š]\s*(.+)/);
          
          const keyword = keywordMatch ? keywordMatch[1].trim() : '';
          const title = titleMatch ? titleMatch[1].trim() : '';
          const category = categoryMatch ? categoryMatch[1].trim() : 'AIãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°';
          const publishDate = dateMatch ? dateMatch[1].trim() : 'immediate';
          
          // çµæœã‚’å‡ºåŠ›
          core.setOutput('keyword', keyword);
          core.setOutput('title', title);
          core.setOutput('category', category);
          core.setOutput('publish_date', publishDate);
          core.setOutput('issue_number', issue.number);
          
          // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
          if (!keyword) {
            core.setFailed('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            
            // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `âŒ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®å½¢å¼ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ï¼š

\`\`\`
ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: AIãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚° æœ€æ–°ãƒˆãƒ¬ãƒ³ãƒ‰
ã‚¿ã‚¤ãƒˆãƒ«: ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
ã‚«ãƒ†ã‚´ãƒªãƒ¼: AIãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°
æŠ•ç¨¿æ—¥: immediate ã¾ãŸã¯ YYYY-MM-DD
\`\`\`
`
            });
          }
    
    - name: âœ… ãƒªã‚¯ã‚¨ã‚¹ãƒˆç¢ºèªã‚³ãƒ¡ãƒ³ãƒˆ
      if: steps.parse-request.outputs.keyword != ''
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: ${{ steps.parse-request.outputs.issue_number }},
            body: `âœ… ãƒ–ãƒ­ã‚°æŠ•ç¨¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸï¼

**è¨­å®šå†…å®¹:**
- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${{ steps.parse-request.outputs.keyword }}
- ã‚¿ã‚¤ãƒˆãƒ«: ${{ steps.parse-request.outputs.title || 'è‡ªå‹•ç”Ÿæˆ' }}
- ã‚«ãƒ†ã‚´ãƒªãƒ¼: ${{ steps.parse-request.outputs.category }}
- æŠ•ç¨¿æ—¥: ${{ steps.parse-request.outputs.publish_date }}

å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™... ğŸš€`
          });
    
    - name: ğŸš€ ãƒ–ãƒ­ã‚°ç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ
      if: steps.parse-request.outputs.keyword != '' && steps.parse-request.outputs.publish_date == 'immediate'
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'blog-on-demand.yml',
            ref: 'main',
            inputs: {
              keyword: '${{ steps.parse-request.outputs.keyword }}',
              title: '${{ steps.parse-request.outputs.title }}',
              category: '${{ steps.parse-request.outputs.category }}',
              instinct: 'learning',
              publish_immediately: true
            }
          });
          
          // å®Œäº†ã‚³ãƒ¡ãƒ³ãƒˆ
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: ${{ steps.parse-request.outputs.issue_number }},
            body: `ğŸ‰ ãƒ–ãƒ­ã‚°ç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼

[Actions ã‚¿ãƒ–](https://github.com/${{ github.repository }}/actions)ã§é€²è¡ŒçŠ¶æ³ã‚’ç¢ºèªã§ãã¾ã™ã€‚`
          });
          
          // Issue ã‚’ã‚¯ãƒ­ãƒ¼ã‚º
          await github.rest.issues.update({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: ${{ steps.parse-request.outputs.issue_number }},
            state: 'closed'
          });
    
    - name: ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç™»éŒ²
      if: steps.parse-request.outputs.keyword != '' && steps.parse-request.outputs.publish_date != 'immediate'
      run: |
        echo "ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æŠ•ç¨¿æ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™"
        # TODO: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æº