name: ğŸ¯ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]

jobs:
  process-keyword-response:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.body, '#keyword:') || contains(github.event.comment.body, '#keyword:')
    
    steps:
    - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“‹ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: ğŸ¯ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºãƒ»ä¿å­˜
      run: |
        node -e "
        const fs = require('fs');
        
        // ã‚¤ã‚·ãƒ¥ãƒ¼ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º
        const content = process.env.GITHUB_EVENT_NAME === 'issues' 
          ? '${{ github.event.issue.body }}'
          : '${{ github.event.comment.body }}';
        
        console.log('Processing content:', content);
        
        // #keyword: ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œç´¢
        const keywordMatch = content.match(/#keyword:\s*(.+)/i);
        
        if (keywordMatch) {
          const keyword = keywordMatch[1].trim();
          console.log('Extracted keyword:', keyword);
          
          // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
          const responseData = {
            keyword: keyword,
            timestamp: new Date().toISOString(),
            approved: true,
            source: 'github_issue',
            user: '${{ github.event.sender.login }}',
            issue_number: '${{ github.event.issue.number }}'
          };
          
          // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          fs.mkdirSync('.github', { recursive: true });
          
          // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
          fs.writeFileSync('.github/keyword-response.json', JSON.stringify(responseData, null, 2));
          
          console.log('Keyword response saved successfully');
          
          // ç’°å¢ƒå¤‰æ•°ã«è¨­å®šï¼ˆæ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ç”¨ï¼‰
          console.log('::set-output name=keyword::' + keyword);
          console.log('::set-output name=success::true');
        } else {
          console.log('No keyword found in content');
          console.log('::set-output name=success::false');
        }
        "
      id: extract-keyword
    
    - name: ğŸ“¤ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒŸãƒƒãƒˆ
      if: steps.extract-keyword.outputs.success == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .github/keyword-response.json
        git commit -m "ğŸ¯ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${{ steps.extract-keyword.outputs.keyword }}"
        git push
    
    - name: ğŸ’¬ ç¢ºèªã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
      if: steps.extract-keyword.outputs.success == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const keyword = '${{ steps.extract-keyword.outputs.keyword }}';
          const comment = `âœ… **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸï¼**
          
          ğŸ¯ **å—ä»˜ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰**: ${keyword}
          â° **å—ä»˜æ™‚åˆ»**: ${new Date().toLocaleString('ja-JP', {timeZone: 'Asia/Tokyo'})}
          
          ğŸ“ ã“ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¬¡å›ã®ãƒ–ãƒ­ã‚°è¨˜äº‹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
          ğŸš€ æ¯æ—¥åˆå‰9æ™‚ã®è‡ªå‹•æŠ•ç¨¿ã§ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
          
          ---
          *LeadFiveè‡ªå‹•ãƒ–ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ã‚ˆã‚Š*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    - name: ğŸ“± LINEé€šçŸ¥é€ä¿¡
      if: steps.extract-keyword.outputs.success == 'true'
      run: |
        if [ -n "${{ secrets.LINE_NOTIFY_TOKEN }}" ]; then
          curl -X POST https://notify-api.line.me/api/notify \
            -H "Authorization: Bearer ${{ secrets.LINE_NOTIFY_TOKEN }}" \
            -d "message=âœ… ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å—ä»˜å®Œäº†ï¼%0A%0AğŸ¯ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${{ steps.extract-keyword.outputs.keyword }}%0AğŸ‘¤ æŠ•ç¨¿è€…: ${{ github.event.sender.login }}%0Aâ° å—ä»˜æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S')%0A%0AğŸ“ æ¬¡å›ã®è‡ªå‹•ãƒ–ãƒ­ã‚°ç”Ÿæˆã§ä½¿ç”¨ã•ã‚Œã¾ã™"
        fi