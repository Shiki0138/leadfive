name: ğŸ¤– Claude AI æ—¥æ¬¡ãƒ–ãƒ­ã‚°è‡ªå‹•ç”Ÿæˆ

on:
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ (UTC 00:00)
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      keyword:
        description: 'æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰'
        required: false
        type: string
      test_mode:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã®æŠ•ç¨¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰'
        required: false
        type: boolean
        default: false

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  UNSPLASH_API_KEY: ${{ secrets.UNSPLASH_API_KEY }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  generate-blog-post:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“… æ—¥ä»˜ã¨æ›œæ—¥ã‚’å–å¾—
      id: date-info
      run: |
        # æ—¥æœ¬æ™‚é–“ã§è¨ˆç®—
        TZ='Asia/Tokyo' date '+%Y-%m-%d' > current_date.txt
        TZ='Asia/Tokyo' date '+%A' | tr '[:upper:]' '[:lower:]' > current_day.txt
        TZ='Asia/Tokyo' date '+%B' | tr '[:upper:]' '[:lower:]' > current_month.txt
        TZ='Asia/Tokyo' date '+%Y' > current_year.txt
        
        echo "date=$(cat current_date.txt)" >> $GITHUB_OUTPUT
        echo "day=$(cat current_day.txt)" >> $GITHUB_OUTPUT
        echo "month=$(cat current_month.txt)" >> $GITHUB_OUTPUT
        echo "year=$(cat current_year.txt)" >> $GITHUB_OUTPUT
    
    - name: ğŸ“‹ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: ğŸ”§ Ruby ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (Jekyllç”¨)
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
    
    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        # Node.jsä¾å­˜é–¢ä¿‚
        cd scripts/blog-automation
        npm init -y
        npm install axios sharp js-yaml dotenv
        cd ../..
        
        # Jekyllä¾å­˜é–¢ä¿‚
        bundle install
    
    - name: ğŸ¯ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰é¸æŠ
      id: keyword-selection
      run: |
        node -e "
        const fs = require('fs');
        const yaml = require('js-yaml');
        const path = require('path');
        
        // æ‰‹å‹•ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
        const manualKeyword = '${{ inputs.keyword }}';
        if (manualKeyword) {
          console.log('Manual keyword provided:', manualKeyword);
          console.log('::set-output name=keyword::' + manualKeyword);
          process.exit(0);
        }
        
        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰è‡ªå‹•é¸æŠ
        const calendarPath = path.join(__dirname, '_data/blog/content-calendar.yml');
        const calendar = yaml.load(fs.readFileSync(calendarPath, 'utf8'));
        
        const day = '${{ steps.date-info.outputs.day }}';
        const month = '${{ steps.date-info.outputs.month }}';
        
        // æ›œæ—¥åˆ¥ãƒ†ãƒ¼ãƒã‹ã‚‰é¸æŠ
        const dayTheme = calendar.weekly_themes[day];
        if (!dayTheme) {
          console.error('No theme found for day:', day);
          process.exit(1);
        }
        
        // ä½¿ç”¨å±¥æ­´ã‚’ãƒã‚§ãƒƒã‚¯
        const historyPath = path.join(__dirname, 'logs/keyword-history.json');
        let history = [];
        if (fs.existsSync(historyPath)) {
          history = JSON.parse(fs.readFileSync(historyPath, 'utf8'));
        }
        
        // 30æ—¥ä»¥å†…ã«ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é¸æŠ
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        const availableKeywords = dayTheme.keywords.filter(keyword => {
          const lastUsed = history.find(h => h.keyword === keyword);
          if (!lastUsed) return true;
          return new Date(lastUsed.date) < thirtyDaysAgo;
        });
        
        // æœˆåˆ¥ç‰¹é›†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚‚å€™è£œã«è¿½åŠ 
        const monthTheme = calendar.monthly_campaigns[month];
        if (monthTheme && monthTheme.special_keywords) {
          availableKeywords.push(...monthTheme.special_keywords);
        }
        
        // ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
        const selectedKeyword = availableKeywords[Math.floor(Math.random() * availableKeywords.length)];
        
        console.log('Selected keyword:', selectedKeyword);
        console.log('Theme:', dayTheme.theme);
        console.log('Structure:', dayTheme.structure);
        console.log('Instinct:', dayTheme.instinct);
        
        // å‡ºåŠ›ã‚’è¨­å®š
        console.log('::set-output name=keyword::' + selectedKeyword);
        console.log('::set-output name=theme::' + dayTheme.theme);
        console.log('::set-output name=structure::' + dayTheme.structure);
        console.log('::set-output name=instinct::' + dayTheme.instinct);
        "
    
    - name: ğŸš€ Claude APIã§ãƒ–ãƒ­ã‚°ç”Ÿæˆ
      id: generate-blog
      run: |
        cd scripts/blog-automation
        
        # ç’°å¢ƒå¤‰æ•°è¨­å®š
        export BLOG_KEYWORD="${{ steps.keyword-selection.outputs.keyword }}"
        export BLOG_STRUCTURE="${{ steps.keyword-selection.outputs.structure }}"
        export BLOG_INSTINCT="${{ steps.keyword-selection.outputs.instinct }}"
        
        # APIã‚­ãƒ¼ã®å­˜åœ¨ç¢ºèª
        if [ -z "${{ env.ANTHROPIC_API_KEY }}" ]; then
          echo "âš ï¸ ANTHROPIC_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ¢ãƒƒã‚¯ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚"
          node mock-blog-generator.js "$BLOG_KEYWORD"
        else
          # ãƒ–ãƒ­ã‚°ç”Ÿæˆå®Ÿè¡Œ
          node claude-blog-generator.js "$BLOG_KEYWORD"
        fi
        
        # ç”Ÿæˆçµæœç¢ºèª
        TODAY="${{ steps.date-info.outputs.date }}"
        NEW_POST=$(find ../../_posts -name "${TODAY}-*.md" -type f | head -1)
        
        if [ -n "$NEW_POST" ]; then
          echo "Generated post: $NEW_POST"
          POST_TITLE=$(grep '^title:' "$NEW_POST" | sed 's/title: *"*\([^"]*\)"*/\1/')
          echo "::set-output name=success::true"
          echo "::set-output name=filename::$(basename $NEW_POST)"
          echo "::set-output name=title::$POST_TITLE"
        else
          echo "::set-output name=success::false"
          exit 1
        fi
    
    - name: ğŸ”¨ Jekyll ãƒ“ãƒ«ãƒ‰
      if: steps.generate-blog.outputs.success == 'true'
      run: |
        bundle exec jekyll build
    
    - name: ğŸ“Š çµ±è¨ˆæ›´æ–°
      if: steps.generate-blog.outputs.success == 'true'
      run: |
        node -e "
        const fs = require('fs');
        const path = require('path');
        
        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å±¥æ­´æ›´æ–°
        const historyPath = path.join(__dirname, 'logs/keyword-history.json');
        let history = [];
        if (fs.existsSync(historyPath)) {
          history = JSON.parse(fs.readFileSync(historyPath, 'utf8'));
        }
        
        history.push({
          keyword: '${{ steps.keyword-selection.outputs.keyword }}',
          date: '${{ steps.date-info.outputs.date }}',
          title: '${{ steps.generate-blog.outputs.title }}',
          filename: '${{ steps.generate-blog.outputs.filename }}'
        });
        
        // æœ€æ–°100ä»¶ã®ã¿ä¿æŒ
        if (history.length > 100) {
          history = history.slice(-100);
        }
        
        fs.mkdirSync(path.dirname(historyPath), { recursive: true });
        fs.writeFileSync(historyPath, JSON.stringify(history, null, 2));
        
        console.log('History updated with', history.length, 'entries');
        "
    
    - name: ğŸ“¤ å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
      if: steps.generate-blog.outputs.success == 'true' && inputs.test_mode != true
      run: |
        git config --local user.email "claude-blog-bot@leadfive.com"
        git config --local user.name "Claude Blog Bot"
        
        # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
        git add _posts/
        git add assets/images/blog/
        git add _site/
        git add logs/
        
        # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        COMMIT_MSG="ğŸ¤– [Claude AI] è‡ªå‹•ãƒ–ãƒ­ã‚°æŠ•ç¨¿: ${{ steps.generate-blog.outputs.title }}"
        git commit -m "$COMMIT_MSG" || echo "No changes to commit"
        
        # ãƒ—ãƒƒã‚·ãƒ¥
        git push origin main
    
    - name: ğŸ“± Slacké€šçŸ¥ï¼ˆæˆåŠŸï¼‰
      if: steps.generate-blog.outputs.success == 'true' && env.SLACK_WEBHOOK_URL != ''
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        curl -X POST $SLACK_WEBHOOK_URL \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "âœ… ãƒ–ãƒ­ã‚°è‡ªå‹•ç”Ÿæˆå®Œäº†",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*âœ… Claude AIã«ã‚ˆã‚‹ãƒ–ãƒ­ã‚°è¨˜äº‹ç”Ÿæˆå®Œäº†*"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ“ ã‚¿ã‚¤ãƒˆãƒ«*\n${{ steps.generate-blog.outputs.title }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ¯ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰*\n${{ steps.keyword-selection.outputs.keyword }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«å*\n${{ steps.generate-blog.outputs.filename }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ¨ ãƒ†ãƒ¼ãƒ*\n${{ steps.keyword-selection.outputs.theme }}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "ğŸŒ è¨˜äº‹ã¯æ•°åˆ†å¾Œã«ã‚µã‚¤ãƒˆã«åæ˜ ã•ã‚Œã¾ã™"
                }
              }
            ]
          }'
    
    - name: ğŸš¨ ã‚¨ãƒ©ãƒ¼é€šçŸ¥
      if: failure()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [ -n "$SLACK_WEBHOOK_URL" ]; then
          curl -X POST $SLACK_WEBHOOK_URL \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "âŒ ãƒ–ãƒ­ã‚°ç”Ÿæˆã‚¨ãƒ©ãƒ¼",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*âŒ Claude AIãƒ–ãƒ­ã‚°ç”Ÿæˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ*\n\nGitHub Actionsãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
                  }
                }
              ]
            }'
        fi

  # é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  weekly-report:
    runs-on: ubuntu-latest
    if: github.event.schedule && format('{0}', steps.date-info.outputs.day) == 'sunday'
    needs: generate-blog-post
    
    steps:
    - name: ğŸ“Š é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      run: |
        echo "Weekly report generation would go here"
        # é€±æ¬¡ã®çµ±è¨ˆæƒ…å ±ã‚’ã¾ã¨ã‚ã¦é€šçŸ¥ã™ã‚‹å‡¦ç†