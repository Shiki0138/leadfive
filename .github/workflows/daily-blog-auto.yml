name: ğŸš€ æ¯æ—¥è‡ªå‹•ãƒ–ãƒ­ã‚°æŠ•ç¨¿

on:
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      keyword:
        description: 'æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰'
        required: false
        type: string
      test_mode:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰'
        required: false
        type: boolean
        default: false

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  generate-daily-blog:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“… æ—¥ä»˜æƒ…å ±å–å¾—
      id: date-info
      run: |
        # æ—¥æœ¬æ™‚é–“ã§è¨ˆç®—
        DATE=$(TZ='Asia/Tokyo' date '+%Y-%m-%d')
        DAY=$(TZ='Asia/Tokyo' date '+%A' | tr '[:upper:]' '[:lower:]')
        TIMESTAMP=$(TZ='Asia/Tokyo' date '+%Y-%m-%dT%H:%M:%S.000Z')
        
        echo "date=$DATE" >> $GITHUB_OUTPUT
        echo "day=$DAY" >> $GITHUB_OUTPUT
        echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
        
        echo "ä»Šæ—¥ã®æ—¥ä»˜: $DATE ($DAY)"
    
    - name: ğŸ¯ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰é¸æŠ
      id: select-keyword
      run: |
        # æ›œæ—¥åˆ¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æˆ¦ç•¥
        case "${{ steps.date-info.outputs.day }}" in
          "monday")
            KEYWORDS=("AI ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚° æœ€æ–°ãƒˆãƒ¬ãƒ³ãƒ‰" "ç”ŸæˆAI æ´»ç”¨æ³• ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°" "ChatGPT ãƒ“ã‚¸ãƒã‚¹æ´»ç”¨ äº‹ä¾‹")
            THEME="AIãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°"
            ;;
          "tuesday")
            KEYWORDS=("æ¶ˆè²»è€…å¿ƒç† 8ã¤ã®æœ¬èƒ½ æ´»ç”¨" "è³¼è²·è¡Œå‹• å¿ƒç†å­¦ åˆ†æ" "é¡§å®¢ã‚¤ãƒ³ã‚µã‚¤ãƒˆ AI ç™ºè¦‹")
            THEME="æ¶ˆè²»è€…å¿ƒç†"
            ;;
          "wednesday")
            KEYWORDS=("AIå°å…¥ æˆåŠŸäº‹ä¾‹ ä¸­å°ä¼æ¥­" "ãƒ‡ã‚¸ã‚¿ãƒ«å¤‰é© äº‹ä¾‹ è£½é€ æ¥­" "CVRæ”¹å–„ æˆåŠŸäº‹ä¾‹ EC")
            THEME="æˆåŠŸäº‹ä¾‹"
            ;;
          "thursday")
            KEYWORDS=("SEOå¯¾ç­– AIæ´»ç”¨ 2025" "SNSãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚° è‡ªå‹•åŒ– æ–¹æ³•" "ãƒ¡ãƒ¼ãƒ«ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚° AI æœ€é©åŒ–")
            THEME="å®Ÿè·µãƒ†ã‚¯ãƒ‹ãƒƒã‚¯"
            ;;
          "friday")
            KEYWORDS=("ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ãƒˆãƒ¬ãƒ³ãƒ‰ 2025 äºˆæ¸¬" "AIæŠ€è¡“ æœ€æ–°å‹•å‘ ãƒ“ã‚¸ãƒã‚¹" "ãƒ‡ã‚¸ã‚¿ãƒ«ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚° æœªæ¥")
            THEME="ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ"
            ;;
          "saturday")
            KEYWORDS=("ç¾å®¹æ¥­ç•Œ AIæ´»ç”¨ å®Œå…¨ã‚¬ã‚¤ãƒ‰" "ä¸å‹•ç”£æ¥­ç•Œ ãƒ‡ã‚¸ã‚¿ãƒ«å¤‰é©" "é£²é£Ÿæ¥­ç•Œ ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°è‡ªå‹•åŒ–")
            THEME="æ¥­ç•Œåˆ¥ã‚¬ã‚¤ãƒ‰"
            ;;
          "sunday")
            KEYWORDS=("ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ AIæ™‚ä»£" "ãƒ“ã‚¸ãƒã‚¹æˆé•· AIæ´»ç”¨ æˆ¦ç•¥" "ç«¶äº‰å„ªä½ æ§‹ç¯‰ æ–¹æ³•")
            THEME="æˆ¦ç•¥ç«‹æ¡ˆ"
            ;;
        esac
        
        # æ‰‹å‹•ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨
        if [ -n "${{ inputs.keyword }}" ]; then
          SELECTED_KEYWORD="${{ inputs.keyword }}"
        else
          # ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
          SELECTED_KEYWORD=${KEYWORDS[$RANDOM % ${#KEYWORDS[@]}]}
        fi
        
        echo "keyword=$SELECTED_KEYWORD" >> $GITHUB_OUTPUT
        echo "theme=$THEME" >> $GITHUB_OUTPUT
        
        echo "é¸æŠã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: $SELECTED_KEYWORD"
        echo "ãƒ†ãƒ¼ãƒ: $THEME"
    
    - name: ğŸš€ ãƒ–ãƒ­ã‚°è¨˜äº‹ç”Ÿæˆ
      id: generate-blog
      run: |
        # è¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
        DATE="${{ steps.date-info.outputs.date }}"
        KEYWORD="${{ steps.select-keyword.outputs.keyword }}"
        THEME="${{ steps.select-keyword.outputs.theme }}"
        
        # ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æ—¥æœ¬èªã‹ã‚‰è‹±æ•°å­—ã«å¤‰æ›
        SAFE_KEYWORD=$(echo "$KEYWORD" | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
        FILENAME="${DATE}-${SAFE_KEYWORD}.md"
        FILEPATH="_posts/$FILENAME"
        
        # ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ
        TITLE="ã€2025å¹´æœ€æ–°ã€‘${KEYWORD}ã®å®Œå…¨ã‚¬ã‚¤ãƒ‰"
        
        # è¨˜äº‹å†…å®¹ç”Ÿæˆ
        cat > "$FILEPATH" << 'EOF'
        ---
        layout: blog-post
        title: "$TITLE"
        date: ${{ steps.date-info.outputs.timestamp }}
        categories: [$THEME]
        tags: [$(echo "$KEYWORD" | tr ' ' ','), AIæ´»ç”¨, ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°, æ¥­å‹™åŠ¹ç‡åŒ–]
        description: "$TITLE"
        author: "LeadFive AI"
        image: "/assets/images/blog/${FILENAME%.md}-featured.jpg"
        featured: true
        reading_time: 3
        ---
        
        # $TITLE
        
        $KEYWORDã«é–¢ã™ã‚‹æœ€æ–°ã®æƒ…å ±ã¨å®Ÿè·µçš„ãªæ´»ç”¨æ–¹æ³•ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚AIæŠ€è¡“ã®é€²æ­©ã«ã‚ˆã‚Šã€å¾“æ¥ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒå¤§ããå¤‰åŒ–ã—ã¦ã„ã‚‹ä»Šã€æœ€æ–°ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’æŠŠæ¡ã™ã‚‹ã“ã¨ãŒæˆåŠŸã®éµã¨ãªã‚Šã¾ã™ã€‚
        
        ## ${KEYWORD}ã®é‡è¦æ€§
        
        ç¾ä»£ã®ãƒ“ã‚¸ãƒã‚¹ç’°å¢ƒã«ãŠã„ã¦ã€$KEYWORDã¯ä¼æ¥­ã®ç«¶äº‰å„ªä½æ€§ã‚’æ±ºå®šã™ã‚‹é‡è¦ãªè¦ç´ ã¨ãªã£ã¦ã„ã¾ã™ã€‚ç‰¹ã«ä»¥ä¸‹ã®ç‚¹ã§å¤§ããªå¤‰åŒ–ãŒèµ·ãã¦ã„ã¾ã™ï¼š
        
        1. **åŠ¹ç‡åŒ–ã®å®Ÿç¾**: AIæŠ€è¡“ã«ã‚ˆã‚Šå¾“æ¥ã®æ‰‹ä½œæ¥­ãŒè‡ªå‹•åŒ–
        2. **ç²¾åº¦ã®å‘ä¸Š**: ãƒ‡ãƒ¼ã‚¿åˆ†æã«ã‚ˆã‚Šæ„æ€æ±ºå®šã®è³ªãŒå‘ä¸Š
        3. **ã‚³ã‚¹ãƒˆå‰Šæ¸›**: è‡ªå‹•åŒ–ã«ã‚ˆã‚Šé‹å–¶ã‚³ã‚¹ãƒˆã®å¤§å¹…å‰Šæ¸›
        
        ## å®Ÿè·µçš„ãªæ´»ç”¨æ–¹æ³•
        
        ### åŸºæœ¬çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
        
        $KEYWORDã‚’åŠ¹æœçš„ã«æ´»ç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¸ã‚€ã“ã¨ãŒé‡è¦ã§ã™ï¼š
        
        - **ç¾çŠ¶åˆ†æ**: æ—¢å­˜ã®èª²é¡Œã¨ãƒ‹ãƒ¼ã‚ºã®æŠŠæ¡
        - **æˆ¦ç•¥ç«‹æ¡ˆ**: ç›®æ¨™è¨­å®šã¨å®Ÿè¡Œè¨ˆç”»ã®ç­–å®š  
        - **å®Ÿè£…**: æ®µéšçš„ãªå°å…¥ã¨åŠ¹æœæ¸¬å®š
        - **æ”¹å–„**: çµæœã«åŸºã¥ãç¶™ç¶šçš„ãªæœ€é©åŒ–
        
        ### æˆåŠŸã®ãƒã‚¤ãƒ³ãƒˆ
        
        å®Ÿéš›ã«$KEYWORDã§æˆæœã‚’ä¸Šã’ã¦ã„ã‚‹ä¼æ¥­ã®å…±é€šç‚¹ï¼š
        
        1. **æ˜ç¢ºãªç›®æ¨™è¨­å®š**: KPIã‚’å…·ä½“çš„ã«å®šç¾©
        2. **æ®µéšçš„å°å…¥**: ãƒªã‚¹ã‚¯ã‚’æœ€å°åŒ–ã—ãªãŒã‚‰æ‹¡å¤§
        3. **ç¶™ç¶šçš„æ”¹å–„**: å®šæœŸçš„ãªè¦‹ç›´ã—ã¨æœ€é©åŒ–
        
        ## ã¾ã¨ã‚
        
        $KEYWORDã¯ã€é©åˆ‡ã«æ´»ç”¨ã™ã‚Œã°å¤§ããªæˆæœã‚’ã‚‚ãŸã‚‰ã™å¯èƒ½æ€§ã‚’ç§˜ã‚ã¦ã„ã¾ã™ã€‚é‡è¦ãªã®ã¯ï¼š
        
        - è‡ªç¤¾ã®çŠ¶æ³ã«åˆã‚ã›ãŸæˆ¦ç•¥çš„ãªå°å…¥
        - ç¶™ç¶šçš„ãªå­¦ç¿’ã¨æ”¹å–„
        - æœ€æ–°ãƒˆãƒ¬ãƒ³ãƒ‰ã¸ã®å¯¾å¿œ
        
        ä»Šã™ã$KEYWORDã®æ´»ç”¨ã‚’å§‹ã‚ã¦ã€ãƒ“ã‚¸ãƒã‚¹ã®æˆé•·ã‚’åŠ é€Ÿã•ã›ã¾ã—ã‚‡ã†ã€‚
        
        ---
        
        *LeadFiveã§ã¯ã€$KEYWORDã®å°å…¥æ”¯æ´ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚ãŠæ°—è»½ã«ã”ç›¸è«‡ãã ã•ã„ã€‚*
        EOF
        
        # å¤‰æ•°ç½®æ›
        sed -i.bak "s/\$TITLE/$TITLE/g" "$FILEPATH"
        sed -i.bak "s/\$KEYWORD/$KEYWORD/g" "$FILEPATH" 
        sed -i.bak "s/\$THEME/$THEME/g" "$FILEPATH"
        rm "${FILEPATH}.bak" 2>/dev/null || true
        
        echo "success=true" >> $GITHUB_OUTPUT
        echo "filename=$FILENAME" >> $GITHUB_OUTPUT
        echo "title=$TITLE" >> $GITHUB_OUTPUT
        echo "filepath=$FILEPATH" >> $GITHUB_OUTPUT
        
        echo "è¨˜äº‹ç”Ÿæˆå®Œäº†: $FILEPATH"
    
    - name: ğŸ”¨ Jekyll ãƒ“ãƒ«ãƒ‰
      if: steps.generate-blog.outputs.success == 'true'
      run: |
        # Rubyã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        bundle install --quiet
        
        # Jekyll ãƒ“ãƒ«ãƒ‰
        bundle exec jekyll build
        
        echo "Jekyll ãƒ“ãƒ«ãƒ‰å®Œäº†"
    
    - name: ğŸ“¤ å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
      if: steps.generate-blog.outputs.success == 'true' && inputs.test_mode != true
      run: |
        git config --local user.email "leadfive-bot@actions.com"
        git config --local user.name "LeadFive Auto Blog Bot"
        
        # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
        git add _posts/
        git add _site/ || true
        
        # ã‚³ãƒŸãƒƒãƒˆ
        COMMIT_MSG="ğŸ¤– è‡ªå‹•ãƒ–ãƒ­ã‚°æŠ•ç¨¿: ${{ steps.generate-blog.outputs.title }}"
        git commit -m "$COMMIT_MSG" || echo "ã‚³ãƒŸãƒƒãƒˆã™ã‚‹å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"
        
        # ãƒ—ãƒƒã‚·ãƒ¥
        git push origin main
        
        echo "è¨˜äº‹ã‚’æ­£å¸¸ã«æŠ•ç¨¿ã—ã¾ã—ãŸ"
    
    - name: ğŸ“± æˆåŠŸé€šçŸ¥
      if: steps.generate-blog.outputs.success == 'true'
      run: |
        echo "âœ… ãƒ–ãƒ­ã‚°è¨˜äº‹ç”Ÿæˆå®Œäº†!"
        echo "ğŸ“ ã‚¿ã‚¤ãƒˆãƒ«: ${{ steps.generate-blog.outputs.title }}"
        echo "ğŸ¯ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${{ steps.select-keyword.outputs.keyword }}"
        echo "ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«: ${{ steps.generate-blog.outputs.filename }}"
        echo "â° æŠ•ç¨¿æ™‚åˆ»: $(TZ='Asia/Tokyo' date)"
        
        # å¿…è¦ã«å¿œã˜ã¦Slack/LINEé€šçŸ¥ã‚’è¿½åŠ å¯èƒ½
        
    - name: ğŸš¨ ã‚¨ãƒ©ãƒ¼é€šçŸ¥
      if: failure()
      run: |
        echo "âŒ ãƒ–ãƒ­ã‚°ç”Ÿæˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
        echo "è©³ç´°ã¯GitHub Actionsãƒ­ã‚°ã‚’ã”ç¢ºèªãã ã•ã„"